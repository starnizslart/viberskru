<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FloodCare+ | ระบบรับแจ้งเหตุและช่วยเหลือผู้ประสบภัย</title>
    <!-- เพิ่ม Tailwind Config เพื่อเปิดใช้งาน Dark Mode แบบ Class -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Prompt', 'sans-serif'] } } }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style type="text/tailwindcss">
        @layer base {
            body { 
                @apply font-sans bg-[#f1f5f9] dark:bg-slate-900 text-slate-800 dark:text-slate-100 transition-colors duration-300; 
            }
        }

        @layer components {
            .glass-card { 
                @apply bg-white/85 dark:bg-slate-800/85 backdrop-blur-[12px] border border-white/50 dark:border-slate-700/50 shadow-sm transition-all duration-300;
            }
            .glass-card:hover {
                @apply shadow-lg transform -translate-y-[2px];
            }
            .input-style {
                @apply w-full px-4 py-2.5 border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:outline-none transition-all bg-slate-50 dark:bg-slate-900/50 focus:bg-white dark:focus:bg-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-slate-500;
            }
            .text-gradient {
                @apply bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400;
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { @apply bg-transparent; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-300 dark:bg-slate-600 rounded-full; }
        ::-webkit-scrollbar-thumb:hover { @apply bg-slate-400 dark:bg-slate-500; }

        /* Loader Animation */
        .spinner { border: 3px solid rgba(0, 0, 0, 0.1); border-left-color: #2563eb; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .dark .spinner { border-left-color: #60a5fa; border: 3px solid rgba(255,255,255,0.1); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }
        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }
        .delay-400 { animation-delay: 400ms; }
        
        /* Stat Icon Wrapper */
        .stat-icon { transition: transform 0.3s ease; }
        .glass-card:hover .stat-icon { transform: scale(1.15) rotate(5deg); }

        /* Localized Rain Effect */
        .rain-cloud-container { position: relative; overflow: hidden; border-radius: 12px; }
        .raindrop {
            position: absolute;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(96, 165, 250, 0.8));
            width: 2px;
            height: 12px;
            border-radius: 50%;
            animation: fall linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(-10px); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(80px); opacity: 0; }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-blue-200 selection:text-blue-900 dark:selection:bg-blue-900 dark:selection:text-blue-100 relative">

    <!-- Background Pattern -->
    <div class="absolute inset-0 z-[-1] pointer-events-none opacity-30 dark:opacity-5 mix-blend-multiply" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'#94a3b8\' fill-opacity=\'1\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>

    <!-- Theme Overlay Effect (Sun/Moon icon pops up on theme toggle) -->
    <div id="theme-icon-overlay" class="fixed inset-0 z-[9999] pointer-events-none flex items-center justify-center transition-all duration-[600ms] opacity-0 scale-50">
    </div>

    <!-- Global Loader -->
    <div id="loader" class="fixed inset-0 bg-white/80 dark:bg-slate-900/80 z-[100] flex flex-col items-center justify-center backdrop-blur-md transition-opacity duration-300 pointer-events-none opacity-0 hidden">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-blue-100 dark:border-blue-900/50 rounded-full"></div>
            <div class="w-16 h-16 border-4 border-blue-600 dark:border-blue-400 rounded-full absolute top-0 left-0 border-t-transparent animate-spin"></div>
        </div>
        <p class="mt-4 text-sm font-semibold text-blue-800 dark:text-blue-300 tracking-wide animate-pulse" id="loader-text">กำลังโหลดข้อมูล...</p>
    </div>

    <!-- ================= LOGIN / REGISTER VIEW ================= -->
    <div id="auth-view" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gradient-to-br from-slate-100 via-blue-50 to-indigo-100 dark:from-slate-900 dark:via-slate-800 dark:to-indigo-950 overflow-hidden transition-colors duration-500">
        
        <!-- Ambient Glowing Orbs Background -->
        <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-400/30 dark:bg-indigo-600/20 rounded-full blur-[100px] z-0 pointer-events-none"></div>
        <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-400/20 dark:bg-blue-600/20 rounded-full blur-[100px] z-0 pointer-events-none"></div>
        
        <!-- Interactive Particle Canvas -->
        <canvas id="authCanvas" class="absolute inset-0 w-full h-full z-0 pointer-events-none"></canvas>

        <div class="glass-card w-full max-w-md rounded-3xl overflow-hidden animate-fade-in-up border border-slate-200/80 dark:border-slate-700/80 z-10 relative shadow-2xl">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-700 dark:to-indigo-800 p-8 text-center text-white relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <svg class="w-14 h-14 mx-auto mb-3 drop-shadow-md relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 21s2-2 4-2 4 2 4 2 4-2 4-2 4 2 4 2"></path></svg>
                <h2 class="text-3xl font-bold relative z-10 tracking-tight">FloodCare+</h2>
                <p class="text-blue-100/90 text-sm mt-2 relative z-10 font-medium">ระบบรับแจ้งเหตุและช่วยเหลือผู้ประสบภัยน้ำท่วม</p>
            </div>
            
            <div class="p-8 bg-white/60 dark:bg-slate-800/60 backdrop-blur-md">
                <!-- Tabs -->
                <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6">
                    <button onclick="toggleAuth('login')" id="tab-login" class="flex-1 py-3 text-center font-semibold text-blue-600 dark:text-blue-400 border-b-2 border-blue-600 dark:border-blue-400 transition-colors">เข้าสู่ระบบ</button>
                    <button onclick="toggleAuth('register')" id="tab-register" class="flex-1 py-3 text-center font-medium text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 transition-colors border-b-2 border-transparent">ลงทะเบียน</button>
                </div>

                <!-- Login Form -->
                <form id="form-login" onsubmit="handleLogin(event)" class="space-y-5 relative">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">ชื่อผู้ใช้งาน (Username)</label>
                        <input type="text" id="login_username" required maxlength="2000" placeholder="กรอกชื่อผู้ใช้งาน" class="input-style">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">รหัสผ่าน (Password)</label>
                        <div class="relative">
                            <input type="password" id="login_password" required maxlength="2000" placeholder="••••••••" class="input-style pr-12">
                            <button type="button" onclick="togglePassword('login_password', this)" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-xl font-semibold shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">เข้าสู่ระบบ</button>
                </form>

                <!-- Register Form -->
                <form id="form-register" onsubmit="handleRegister(event)" class="space-y-4 hidden max-h-[55vh] overflow-y-auto pr-2 custom-scrollbar relative">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ชื่อ-นามสกุล (Name)</label>
                        <input type="text" id="reg_name" required pattern="[a-zA-Zก-ฮะ-์\s]+" minlength="2" maxlength="2000" title="กรุณากรอกเฉพาะตัวอักษรภาษาไทยหรือภาษาอังกฤษเท่านั้น" oninput="this.value = this.value.replace(/[^a-zA-Zก-ฮะ-์\s]/g, '')" placeholder="ชื่อ-นามสกุล จริง" class="input-style">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ชื่อผู้ใช้งาน (Username)</label>
                        <input type="text" id="reg_username" required pattern="[a-zA-Z0-9]+" minlength="4" maxlength="20" title="ใช้ภาษาอังกฤษและตัวเลขเท่านั้น (4-20 ตัวอักษร)" placeholder="ภาษาอังกฤษหรือตัวเลข 4 ตัวขึ้นไป" class="input-style">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">รหัสผ่าน (Password)</label>
                        <div class="relative">
                            <input type="password" id="reg_password" required minlength="6" maxlength="2000" title="รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร" placeholder="อย่างน้อย 6 ตัวอักษร" class="input-style pr-12">
                            <button type="button" onclick="togglePassword('reg_password', this)" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ยืนยันรหัสผ่าน (Confirm Password)</label>
                        <div class="relative">
                            <input type="password" id="reg_confirm_password" required minlength="6" maxlength="2000" placeholder="กรอกรหัสผ่านอีกครั้ง" class="input-style pr-12">
                            <button type="button" onclick="togglePassword('reg_confirm_password', this)" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">เบอร์ติดต่อ (Phone)</label>
                        <input type="tel" id="reg_phone" required pattern="[0-9]{9,10}" maxlength="10" title="กรอกเฉพาะตัวเลข 9-10 หลัก" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="08XXXXXXXX" class="input-style">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ประเภทบัญชี (Role)</label>
                        <select id="reg_role" class="input-style cursor-pointer appearance-none">
                            <option value="user">ผู้ประสบภัย / ผู้แจ้งเหตุ (User)</option>
                            <option value="admin">เจ้าหน้าที่ศูนย์ฯ (Admin)</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full py-3 mt-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-semibold shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">สร้างบัญชีผู้ใช้</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ================= MAIN APP VIEW ================= -->
    <div id="main-app" class="flex w-full h-full hidden">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white/70 dark:bg-slate-900/70 backdrop-blur-2xl border-r border-slate-200/50 dark:border-slate-800/50 flex flex-col hidden md:flex z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)] transition-colors duration-300">
            <div class="h-20 flex items-center px-6 border-b border-slate-200/50 dark:border-slate-800/50 shrink-0">
                <div class="text-2xl font-bold flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 21s2-2 4-2 4 2 4 2 4-2 4-2 4 2 4 2"></path></svg>
                    </div>
                    <span class="text-gradient">FloodCare+</span>
                </div>
            </div>
            
            <nav class="flex-1 p-4 overflow-y-auto custom-scrollbar" id="sidebar-nav">
                
                <!-- Menu Admin -->
                <div id="menu-admin" class="hidden">
                    <p class="px-3 text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2 mt-2">จัดการระบบ (Main)</p>
                    <div class="space-y-1.5">
                        <button onclick="switchView('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-xl font-semibold nav-btn transition-all duration-300" data-view="dashboard">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                            Dashboard
                        </button>
                        <button onclick="switchView('list')" class="w-full flex items-center justify-between px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white rounded-xl font-medium nav-btn transition-all duration-300" data-view="list">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                จัดการรายการแจ้งเหตุ
                            </div>
                            <span id="badge-admin-list" class="hidden bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full animate-pulse shadow-lg shadow-rose-500/40">0</span>
                        </button>
                        <button onclick="switchView('manage-map')" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white rounded-xl font-medium nav-btn transition-all duration-300" data-view="manage-map">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            จัดการจุดแจกของ
                        </button>
                        <button onclick="switchView('reports')" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white rounded-xl font-medium nav-btn transition-all duration-300" data-view="reports">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            รายงานสถิติ
                        </button>
                    </div>

                    <p class="px-3 text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2 mt-6">ตั้งค่าระบบ (System)</p>
                    <div class="space-y-1.5">
                        <button onclick="switchView('users')" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white rounded-xl font-medium nav-btn transition-all duration-300" data-view="users">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            จัดการบัญชีผู้ใช้งาน
                        </button>
                        <button onclick="switchView('settings')" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white rounded-xl font-medium nav-btn transition-all duration-300" data-view="settings">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            ตั้งค่าโปรไฟล์ส่วนตัว
                        </button>
                    </div>
                </div>

                <!-- Menu User -->
                <div id="menu-user" class="hidden">
                    <p class="px-3 text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2 mt-2">บริการ (Services)</p>
                    <div class="space-y-1.5">
                        <button onclick="switchView('form')" class="w-full flex items-center gap-3 px-4 py-3 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-xl font-semibold nav-btn transition-all duration-300" data-view="form">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            แจ้งเหตุฉุกเฉิน
                        </button>
                        <button onclick="switchView('list')" class="w-full flex items-center justify-between px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white rounded-xl font-medium nav-btn transition-all duration-300" data-view="list">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                ติดตามสถานะ
                            </div>
                            <span id="badge-user-list" class="hidden bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg shadow-rose-500/40">0</span>
                        </button>
                        <button onclick="switchView('news')" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white rounded-xl font-medium nav-btn transition-all duration-300" data-view="news">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2.5 2.5 0 00-2.5-2.5H15"></path></svg>
                            ข่าวสาร & จุดรับของ
                        </button>
                        <button onclick="switchView('history')" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white rounded-xl font-medium nav-btn transition-all duration-300" data-view="history">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            ประวัติการแจ้งเหตุ
                        </button>
                    </div>

                    <p class="px-3 text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2 mt-6">ช่วยเหลือ (Support)</p>
                    <div class="space-y-1.5">
                        <button onclick="switchView('faq')" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white rounded-xl font-medium nav-btn transition-all duration-300" data-view="faq">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            ศูนย์ช่วยเหลือ (FAQ)
                        </button>
                        <button onclick="switchView('settings')" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100/80 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white rounded-xl font-medium nav-btn transition-all duration-300" data-view="settings">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            ตั้งค่าโปรไฟล์ส่วนตัว
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Bottom Actions (Theme Toggle & Logout) -->
            <div class="p-4 border-t border-slate-200/50 dark:border-slate-800/50 bg-slate-50/50 dark:bg-slate-900/50 flex flex-col gap-3">
                
                <!-- Dark Mode Toggle Switch -->
                <div class="flex items-center justify-between px-3 py-2 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <span class="text-sm font-semibold text-slate-600 dark:text-slate-300 flex items-center gap-2">
                        <svg class="w-4 h-4 text-amber-500 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg class="w-4 h-4 text-indigo-400 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        โหมดกลางคืน
                    </span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="theme-toggle" class="sr-only peer" onchange="toggleTheme()">
                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-indigo-500"></div>
                    </label>
                </div>

                <div class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors cursor-pointer group" onclick="switchView('settings')">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div id="avatar" class="w-9 h-9 shrink-0 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold text-sm shadow-md">U</div>
                        <div class="text-sm overflow-hidden">
                            <p id="display_name" class="font-bold text-slate-800 dark:text-slate-100 truncate w-24">ชื่อผู้ใช้</p>
                            <p id="display_role" class="text-xs text-slate-500 dark:text-slate-400 capitalize">Role</p>
                        </div>
                    </div>
                    <button onclick="logout(); event.stopPropagation();" class="p-2 text-slate-400 hover:text-rose-500 dark:hover:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-900/30 rounded-lg transition-all" title="ออกจากระบบ">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden">
            
            <!-- Header -->
            <header class="h-20 bg-white/70 dark:bg-slate-900/70 backdrop-blur-lg border-b border-slate-200/80 dark:border-slate-800/80 flex items-center justify-between px-8 shrink-0 shadow-sm z-10 sticky top-0 transition-colors duration-300">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight transition-colors duration-300" id="header-title">แดชบอร์ด</h1>
                    <p class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-0.5 hidden md:block" id="header-subtitle">ยินดีต้อนรับเข้าสู่ศูนย์ปฏิบัติการ</p>
                </div>
                <div class="flex items-center gap-5">
                    <div class="hidden sm:flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 font-medium bg-white dark:bg-slate-800 px-4 py-1.5 rounded-full shadow-sm border border-slate-100 dark:border-slate-700 transition-colors duration-300">
                        <svg class="w-4 h-4 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span id="currentDate"></span>
                    </div>
                    <button onclick="fetchData()" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 border border-slate-200 dark:border-slate-700 hover:border-blue-200 dark:hover:border-blue-500 rounded-xl text-sm transition-all font-semibold shadow-sm hover:shadow active:scale-95">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        <span class="hidden sm:inline">อัปเดตข้อมูล</span>
                    </button>
                </div>
            </header>

            <!-- Views Container -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8 relative custom-scrollbar">
                
                <!-- VIEW 1: DASHBOARD (ADMIN ONLY) -->
                <div id="view-dashboard" class="view-section hidden max-w-7xl mx-auto">
                    
                    <div class="mb-8 animate-fade-in-up">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">ภาพรวมระบบ (Overview)</h2>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">สรุปสถานการณ์การรับแจ้งเหตุทั้งหมดภายในระบบ ณ ปัจจุบัน</p>
                    </div>

                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass-card rounded-2xl p-6 relative overflow-hidden animate-fade-in-up delay-100 group">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-100 dark:bg-blue-900/40 rounded-bl-full -z-10 opacity-50 transition-transform group-hover:scale-110"></div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">เคสทั้งหมด</p>
                                    <h3 class="text-4xl font-extrabold text-slate-800 dark:text-white mt-2" id="stat-total">0</h3>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center text-blue-600 dark:text-blue-400 stat-icon shadow-inner">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-card rounded-2xl p-6 relative overflow-hidden animate-fade-in-up delay-200 group">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-amber-100 dark:bg-amber-900/40 rounded-bl-full -z-10 opacity-50 transition-transform group-hover:scale-110"></div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">กำลังดำเนินการ</p>
                                    <h3 class="text-4xl font-extrabold text-amber-500 dark:text-amber-400 mt-2" id="stat-progress">0</h3>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/50 flex items-center justify-center text-amber-600 dark:text-amber-400 stat-icon shadow-inner">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl p-6 relative overflow-hidden animate-fade-in-up delay-300 group">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-100 dark:bg-emerald-900/40 rounded-bl-full -z-10 opacity-50 transition-transform group-hover:scale-110"></div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">ยุติเรื่องแล้ว</p>
                                    <h3 class="text-4xl font-extrabold text-emerald-500 dark:text-emerald-400 mt-2" id="stat-closed">0</h3>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-emerald-100 dark:bg-emerald-900/50 flex items-center justify-center text-emerald-600 dark:text-emerald-400 stat-icon shadow-inner">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl p-6 relative overflow-hidden animate-fade-in-up delay-400 group">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-rose-100 dark:bg-rose-900/40 rounded-bl-full -z-10 opacity-50 transition-transform group-hover:scale-110"></div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">ไม่รับเคส / ซ้ำซ้อน</p>
                                    <h3 class="text-4xl font-extrabold text-rose-500 dark:text-rose-400 mt-2" id="stat-rejected">0</h3>
                                </div>
                                <div class="w-12 h-12 rounded-full bg-rose-100 dark:bg-rose-900/50 flex items-center justify-center text-rose-600 dark:text-rose-400 stat-icon shadow-inner">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="glass-card rounded-2xl p-6 lg:col-span-1 animate-fade-in-up delay-300">
                            <div class="flex items-center gap-2 mb-6">
                                <div class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <h2 class="text-lg font-bold text-slate-800 dark:text-white">ความล่าช้า (SLA)</h2>
                            </div>
                            <div class="relative h-56 w-full"><canvas id="slaChart"></canvas></div>
                        </div>
                        <div class="glass-card rounded-2xl p-6 lg:col-span-2 animate-fade-in-up delay-400">
                            <div class="flex items-center gap-2 mb-6">
                                <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                </div>
                                <h2 class="text-lg font-bold text-slate-800 dark:text-white">ประเภทความช่วยเหลือ</h2>
                            </div>
                            <div class="relative h-56 w-full"><canvas id="categoryChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: FORM (USER ONLY) -->
                <div id="view-form" class="view-section hidden max-w-4xl mx-auto animate-fade-in-up">
                    <form id="caseForm" onsubmit="submitCase(event)" class="space-y-6">
                        <div class="glass-card rounded-2xl shadow-xl overflow-hidden relative">
                            <div class="h-2 w-full bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
                            
                            <div class="p-8">
                                <div class="flex items-center gap-3 mb-8 pb-4 border-b border-slate-100 dark:border-slate-700">
                                    <div class="w-12 h-12 rounded-xl bg-blue-50 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400 flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">สร้างฟอร์มแจ้งเหตุฉุกเฉิน / ร้องทุกข์</h2>
                                        <p class="text-sm text-slate-500 dark:text-slate-400">กรุณากรอกข้อมูลให้ครบถ้วนเพื่อความรวดเร็วในการเข้าช่วยเหลือ</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="col-span-1">
                                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">ชื่อ-นามสกุลผู้ประสบภัย / ผู้แจ้ง</label>
                                        <input type="text" id="entrepreneur_name" readonly class="input-style bg-slate-200 dark:bg-slate-800/80 cursor-not-allowed opacity-80" title="ดึงข้อมูลอัตโนมัติ ไม่สามารถแก้ไขได้">
                                    </div>
                                    <div class="col-span-1">
                                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">จำนวนผู้ประสบภัยในจุดนี้ <span class="text-rose-500">*</span></label>
                                        <input type="text" id="company_name" required maxlength="2000" class="input-style" placeholder="เช่น 3 คน (มีเด็ก 1 คน)">
                                    </div>
                                    <div class="col-span-2 md:col-span-1">
                                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">เบอร์ติดต่อ</label>
                                        <input type="text" id="contact_number" readonly class="input-style bg-slate-200 dark:bg-slate-800/80 cursor-not-allowed opacity-80" placeholder="ไม่พบข้อมูลเบอร์โทรศัพท์" title="ดึงข้อมูลอัตโนมัติ ไม่สามารถแก้ไขได้">
                                    </div>
                                    <div class="col-span-2 md:col-span-1">
                                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">พิกัด / ที่อยู่แบบละเอียด <span class="text-rose-500">*</span></label>
                                        <input type="text" id="location" required maxlength="2000" placeholder="บ้านเลขที่, ซอย, จุดสังเกตที่ชัดเจน..." class="input-style">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">ประเภทความช่วยเหลือที่ต้องการ <span class="text-rose-500">*</span></label>
                                        <select id="category" required class="input-style appearance-none cursor-pointer">
                                            <option value="">-- เลือกหมวดหมู่ --</option>
                                            <option value="อพยพฉุกเฉิน / กู้ชีพ">อพยพฉุกเฉิน / กู้ชีพ</option>
                                            <option value="อาหาร / น้ำดื่ม / ถุงยังชีพ">อาหาร / น้ำดื่ม / ถุงยังชีพ</option>
                                            <option value="ยารักษาโรค / สิ่งของจำเป็นอื่นๆ">ยารักษาโรค / สิ่งของจำเป็นอื่นๆ</option>
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">รายละเอียดสถานการณ์เบื้องต้น <span class="text-rose-500">*</span></label>
                                        <textarea id="problem_desc" rows="4" required maxlength="2000" class="input-style resize-none" placeholder="เช่น ระดับน้ำสูงเท่าไหร่, มีผู้ป่วยติดเตียงหรือไม่, ต้องการอะไรด่วนที่สุด..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-slate-50/50 dark:bg-slate-800/50 p-6 border-t border-slate-100 dark:border-slate-700 flex justify-end">
                                <button type="submit" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 transform hover:-translate-y-0.5 transition-all flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                    ส่งแจ้งเหตุฉุกเฉิน
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- VIEW 3: CASE LIST (Shared Admin/User) -->
                <div id="view-list" class="view-section hidden h-full flex flex-col max-w-7xl mx-auto animate-fade-in-up">
                    <div class="glass-card rounded-2xl shadow-sm flex-1 flex flex-col overflow-hidden">
                        <div class="p-6 border-b border-slate-200/60 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white" id="table-title">รายการแจ้งเหตุ</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">ข้อมูลผู้ประสบภัยที่รอการช่วยเหลือ หรือกำลังดำเนินการ</p>
                            </div>
                            <div class="relative w-full sm:w-72">
                                <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="searchInput" onkeyup="filterTable('case-table-body', 'searchInput')" placeholder="ค้นหารหัส, ชื่อ, สถานที่..." class="input-style pl-10">
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto bg-white/40 dark:bg-slate-900/40 custom-scrollbar">
                            <table class="min-w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-slate-50/90 dark:bg-slate-800/90 backdrop-blur-md text-slate-600 dark:text-slate-300 font-semibold sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">รหัสอ้างอิง</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">วันที่แจ้งเหตุ</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">ผู้แจ้งเรื่อง</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">ประเภทการแจ้ง</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">สถานะ</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 text-center">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="case-table-body" class="divide-y divide-slate-100 dark:divide-slate-800/50 bg-white/80 dark:bg-slate-800/50">
                                    <tr><td colspan="6" class="text-center py-12 text-slate-400 font-medium">กำลังโหลดข้อมูล...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: NEWS & MAP (User Only) -->
                <div id="view-news" class="view-section hidden max-w-7xl mx-auto animate-fade-in-up">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <!-- Weather Alert Widget -->
                        <div class="glass-card rounded-3xl p-6 lg:col-span-1 bg-gradient-to-b from-slate-700 to-slate-900 border-none shadow-xl text-white relative overflow-hidden flex flex-col justify-center items-center h-64">
                            <h3 class="text-lg font-bold mb-4 z-10 opacity-90 tracking-wide">แจ้งเตือนสภาพอากาศ</h3>
                            
                            <!-- Cloud & Rain Emoji Animation -->
                            <div class="rain-cloud-container w-32 h-32 flex flex-col items-center justify-start z-10 relative">
                                <div class="text-6xl absolute top-0 z-20 drop-shadow-lg">☁️</div>
                                <!-- Script will generate raindrops here -->
                                <div id="mini-rain" class="absolute top-10 left-0 w-full h-full"></div>
                            </div>
                            
                            <div class="z-10 text-center mt-2">
                                <p class="font-bold text-2xl text-blue-200">พายุฝนฟ้าคะนอง</p>
                                <p class="text-sm text-slate-300 mt-1">เฝ้าระวังน้ำหลาก 24 ชม.</p>
                            </div>
                        </div>

                        <!-- Map Widget -->
                        <div class="glass-card rounded-3xl p-6 lg:col-span-2 flex flex-col h-[500px] lg:h-auto">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 rounded-xl bg-rose-100 text-rose-600 flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800 dark:text-white">แผนที่จุดแจกของยังชีพ</h3>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">สำหรับผู้ประสบภัยที่สามารถเดินทางมารับได้ด้วยตนเอง</p>
                                </div>
                            </div>
                            <div class="flex-1 rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 relative bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                                <!-- จำลอง Map iframe พื้นที่ภาคใต้/สงขลา -->
                                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d126661.34185202685!2d100.43575975!3d7.1687588!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x304d32cf78888065%3A0x10223bc2c3641b0!2sSongkhla%2C%20Mueang%20Songkhla%20District%2C%20Songkhla!5e0!3m2!1sen!2sth!4v1700000000000!5m2!1sen!2sth" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                                
                                <!-- Mock Map Overlay Overlay (สำหรับจำลองจุดรับของ) -->
                                <div class="absolute top-4 right-4 bg-white/90 dark:bg-slate-900/90 backdrop-blur-sm p-3 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 text-xs w-48">
                                    <p class="font-bold text-slate-800 dark:text-white mb-2 pb-1 border-b border-slate-200 dark:border-slate-700">จุดรับของวันนี้</p>
                                    <ul class="space-y-2">
                                        <li class="flex items-start gap-2">
                                            <span class="w-2 h-2 rounded-full bg-rose-500 mt-1 shrink-0 animate-pulse"></span>
                                            <span class="text-slate-600 dark:text-slate-300">วัดหนองบัว (ข้าวกล่อง)</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <span class="w-2 h-2 rounded-full bg-blue-500 mt-1 shrink-0 animate-pulse"></span>
                                            <span class="text-slate-600 dark:text-slate-300">อบต. ท่าช้าง (ถุงยังชีพ)</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: MANAGE MAP (Admin Only) -->
                <div id="view-manage-map" class="view-section hidden max-w-5xl mx-auto animate-fade-in-up">
                    <div class="glass-card rounded-2xl shadow-sm border border-slate-200/60 dark:border-slate-700 overflow-hidden">
                        <div class="p-6 border-b border-slate-200/60 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50">
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">จัดการจุดแจกของยังชีพ</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">เพิ่มพิกัดหรือประกาศจุดตั้งศูนย์ช่วยเหลือชั่วคราว (ระบบจำลอง)</p>
                        </div>
                        <div class="p-6 bg-slate-50/50 dark:bg-slate-900/50">
                            <form class="grid grid-cols-1 md:grid-cols-3 gap-4" onsubmit="alert('ฟังก์ชันจำลอง: บันทึกพิกัดจุดแจกของสำเร็จ'); event.preventDefault();">
                                <div>
                                    <label class="block text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">ชื่อจุดรับของ / สถานที่</label>
                                    <input type="text" required class="input-style !py-2 text-sm" placeholder="เช่น ศาลาวัด..., โรงเรียน...">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">สิ่งของที่แจก (ประเภท)</label>
                                    <input type="text" required class="input-style !py-2 text-sm" placeholder="เช่น ข้าวกล่อง, ถุงยังชีพ">
                                </div>
                                <div class="flex items-end gap-2">
                                    <div class="flex-1">
                                        <label class="block text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">พิกัด (Google Maps Link)</label>
                                        <input type="url" class="input-style !py-2 text-sm" placeholder="https://maps.app.goo.gl/...">
                                    </div>
                                    <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-semibold transition-all mb-[1px]">ปักหมุด</button>
                                </div>
                            </form>
                        </div>
                        <table class="min-w-full text-left text-sm whitespace-nowrap border-t border-slate-200 dark:border-slate-700">
                            <thead class="bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-semibold border-b border-slate-200 dark:border-slate-700">
                                <tr>
                                    <th class="px-6 py-3">สถานที่</th>
                                    <th class="px-6 py-3">รายการที่แจก</th>
                                    <th class="px-6 py-3 text-center">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700/50 bg-white/50 dark:bg-slate-900/30">
                                <tr>
                                    <td class="px-6 py-4 font-medium text-slate-800 dark:text-slate-200">วัดหนองบัว</td>
                                    <td class="px-6 py-4 text-blue-600 dark:text-blue-400">ข้าวกล่อง 500 กล่อง</td>
                                    <td class="px-6 py-4 text-center"><button class="text-rose-500 hover:underline" onclick="alert('จำลองการลบ')">ลบ</button></td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 font-medium text-slate-800 dark:text-slate-200">อบต. ท่าช้าง</td>
                                    <td class="px-6 py-4 text-blue-600 dark:text-blue-400">ถุงยังชีพ 100 ชุด</td>
                                    <td class="px-6 py-4 text-center"><button class="text-rose-500 hover:underline" onclick="alert('จำลองการลบ')">ลบ</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: REPORTS (Admin Only) -->
                <div id="view-reports" class="view-section hidden max-w-7xl mx-auto animate-fade-in-up">
                    <div class="glass-card rounded-2xl p-8 text-center flex flex-col items-center justify-center min-h-[50vh]">
                        <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mb-6 shadow-inner border border-blue-200 dark:border-blue-800">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">รายงานข้อมูลการช่วยเหลือ</h2>
                        <p class="text-slate-500 dark:text-slate-400 mb-8 max-w-md mx-auto">ดาวน์โหลดฐานข้อมูลเหตุการณ์ทั้งหมดในรูปแบบไฟล์ CSV เพื่อนำไปใช้สรุปยอด หรือวิเคราะห์พื้นที่เสี่ยงใน Excel</p>
                        <button onclick="exportToCSV()" class="px-8 py-3 bg-slate-800 hover:bg-slate-900 dark:bg-white dark:hover:bg-slate-100 dark:text-slate-900 text-white rounded-xl font-bold shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            ดาวน์โหลดข้อมูล (Export CSV)
                        </button>
                    </div>
                </div>

                <!-- VIEW: USERS (Admin Only) -->
                <div id="view-users" class="view-section hidden h-full flex flex-col max-w-7xl mx-auto animate-fade-in-up">
                    <div class="glass-card rounded-2xl shadow-sm flex-1 flex flex-col overflow-hidden">
                        <div class="p-6 border-b border-slate-200/60 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white">จัดการบัญชีผู้ใช้งาน</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">รายชื่อผู้มีสิทธิ์เข้าใช้งานระบบทั้งหมด</p>
                            </div>
                            <button class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-semibold shadow-md transition-colors flex items-center gap-2" onclick="openAddUserModal()">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                เพิ่มผู้ใช้
                            </button>
                        </div>
                        <div class="flex-1 overflow-auto bg-white/40 dark:bg-slate-900/40 custom-scrollbar">
                            <table class="min-w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-slate-50/90 dark:bg-slate-800/90 backdrop-blur-md text-slate-600 dark:text-slate-300 font-semibold sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">ชื่อบัญชี (Username)</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">ชื่อ-นามสกุล</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">ระดับสิทธิ์ (Role)</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 text-center">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="divide-y divide-slate-100 dark:divide-slate-800/50 bg-white/80 dark:bg-slate-800/50">
                                    <tr><td colspan="4" class="text-center py-12 text-slate-400 font-medium">กำลังโหลดข้อมูลผู้ใช้...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: SETTINGS (Shared) -->
                <div id="view-settings" class="view-section hidden max-w-3xl mx-auto animate-fade-in-up">
                    <div class="glass-card rounded-2xl p-8 shadow-md border border-slate-200/60 dark:border-slate-700">
                        <div class="flex items-center gap-3 mb-8 pb-4 border-b border-slate-100 dark:border-slate-700">
                            <div class="w-12 h-12 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 flex items-center justify-center border border-slate-200 dark:border-slate-600 shadow-inner">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white">ตั้งค่าบัญชี (Profile Settings)</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400">อัปเดตข้อมูลส่วนตัวและรหัสผ่านของคุณ</p>
                            </div>
                        </div>
                        
                        <form onsubmit="handleUpdateProfile(event)" class="space-y-6 max-w-lg">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">ชื่อ-นามสกุล ที่แสดงผล</label>
                                <input type="text" id="set_name" required pattern="[a-zA-Zก-ฮะ-์\s]+" minlength="2" title="กรุณากรอกเฉพาะตัวอักษรภาษาไทยหรือภาษาอังกฤษเท่านั้น" oninput="this.value = this.value.replace(/[^a-zA-Zก-ฮะ-์\s]/g, '')" class="input-style font-medium text-blue-600 dark:text-blue-400">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">เบอร์ติดต่อ</label>
                                <input type="tel" id="set_phone" required pattern="[0-9]{9,10}" maxlength="10" title="กรอกเฉพาะตัวเลข 9-10 หลัก" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="input-style font-medium text-blue-600 dark:text-blue-400">
                            </div>
                            <div class="pt-4 border-t border-slate-100 dark:border-slate-700">
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">รหัสผ่านใหม่ (เว้นว่างหากไม่ต้องการเปลี่ยน)</label>
                                <div class="relative">
                                    <input type="password" id="set_password" minlength="6" class="input-style pr-12" placeholder="••••••••">
                                    <button type="button" onclick="togglePassword('set_password', this)" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-blue-500 transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">ยืนยันรหัสผ่านใหม่</label>
                                <div class="relative">
                                    <input type="password" id="set_confirm_password" minlength="6" class="input-style pr-12" placeholder="กรอกรหัสผ่านใหม่อีกครั้ง">
                                    <button type="button" onclick="togglePassword('set_confirm_password', this)" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-blue-500 transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="pt-4 flex gap-3">
                                <button type="submit" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-md shadow-blue-500/30 transition-all transform hover:-translate-y-0.5">บันทึกการตั้งค่า</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- VIEW: HISTORY (User Only) -->
                <div id="view-history" class="view-section hidden h-full flex flex-col max-w-7xl mx-auto animate-fade-in-up">
                    <div class="glass-card rounded-2xl shadow-sm flex-1 flex flex-col overflow-hidden border border-slate-200/60 dark:border-slate-700">
                        <div class="p-6 border-b border-slate-200/60 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white">ประวัติการแจ้งเหตุ</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">ประวัติเคสทั้งหมดของคุณ รวมถึงเคสที่อยู่ระหว่างช่วยเหลือ และยุติเรื่องแล้ว</p>
                            </div>
                            <div class="relative w-full sm:w-64">
                                <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="searchHistoryInput" onkeyup="filterTable('history-table-body', 'searchHistoryInput')" placeholder="ค้นหาประวัติ..." class="input-style pl-10">
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto bg-white/40 dark:bg-slate-900/40 custom-scrollbar">
                            <table class="min-w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-slate-50/90 dark:bg-slate-800/90 backdrop-blur-md text-slate-600 dark:text-slate-300 font-semibold sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">รหัสอ้างอิง</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">วันที่แจ้งเหตุ</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">ประเภทการแจ้ง</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">สถานะล่าสุด</th>
                                        <th class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 text-center">ดูข้อมูล</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body" class="divide-y divide-slate-100 dark:divide-slate-800/50 bg-white/80 dark:bg-slate-800/50">
                                    <!-- Rendered via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: FAQ (User Only) -->
                <div id="view-faq" class="view-section hidden max-w-4xl mx-auto animate-fade-in-up">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">ศูนย์ช่วยเหลือ (FAQ)</h2>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">คำถามที่พบบ่อยเกี่ยวกับการใช้งานระบบรับแจ้งเหตุน้ำท่วม</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="glass-card p-6 rounded-2xl border-l-4 border-l-blue-500">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-2">Q: การเข้าช่วยเหลือใช้เวลาเท่าไหร่?</h3>
                            <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm">A: ทีมงานจะประเมินความเร่งด่วนจากข้อมูลที่ท่านให้ หากเป็นกรณีอพยพฉุกเฉินหรือมีผู้ป่วยติดเตียง จะประสานงานทีมกู้ภัยเข้าพื้นที่ทันที ภายใน 1-3 ชั่วโมง ส่วนการส่งเสบียงจะทยอยจัดส่งภายในวันครับ</p>
                        </div>
                        <div class="glass-card p-6 rounded-2xl border-l-4 border-l-teal-500">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-2">Q: สถานะ "ส่งต่อแล้ว" หมายความว่าอย่างไร?</h3>
                            <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm">A: หมายถึงศูนย์รับเรื่องได้ส่งข้อมูลพิกัดและรายละเอียดของท่าน ไปยังหน่วยกู้ภัยหรือหน่วยงานส่วนท้องถิ่น (ปภ., อบต., ทหาร) ที่อยู่ใกล้เคียงที่สุด เพื่อเตรียมลงพื้นที่แล้วครับ คุณสามารถดูชื่อผู้ประสานงานได้ในปุ่ม 'รายละเอียด' ของหน้ารายการเคส</p>
                        </div>
                        <div class="glass-card p-6 rounded-2xl border-l-4 border-l-indigo-500">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-2">Q: หากต้องการแนบไฟล์ภาพสถานที่เกิดเหตุต้องทำอย่างไร?</h3>
                            <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm">A: ในเวอร์ชันนี้กรุณาแจ้งพิกัดและรายละเอียดสถานการณ์ให้ชัดเจนที่สุดในช่องข้อความ หากเจ้าหน้าที่ต้องการภาพเพิ่มเติม จะทำการติดต่อกลับไปยังเบอร์โทรศัพท์ที่ท่านได้ให้ไว้ครับ</p>
                        </div>
                        <div class="glass-card p-6 rounded-2xl border-l-4 border-l-amber-500">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-2">Q: จุดสีแดงที่เมนูคืออะไร?</h3>
                            <p class="text-slate-600 dark:text-slate-400 leading-relaxed text-sm">A: จุดสีแดงจะปรากฏขึ้นเมื่อมี "การอัปเดตสถานะการช่วยเหลือ" จากเจ้าหน้าที่ คุณสามารถกดเข้าไปดูรายละเอียดเพื่อรับทราบความคืบหน้า เมื่อเปิดดูแล้วจุดสีแดงจะหายไปอัตโนมัติ</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal Admin Action (Evaluate) -->
    <div id="admin-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 hidden transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col transform transition-transform scale-95 border border-slate-200 dark:border-slate-700" id="admin-modal-content">
            <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/80">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 flex items-center justify-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800 dark:text-white">ดำเนินการเคส: <span id="modal-case-id" class="text-indigo-600 dark:text-indigo-400"></span></h3>
                </div>
                <button onclick="closeAdminModal()" class="text-slate-400 hover:text-slate-700 dark:hover:text-white hover:bg-slate-200 dark:hover:bg-slate-700 p-1.5 rounded-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar bg-white dark:bg-slate-900">
                <div class="mb-6 p-5 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-100 dark:border-blue-800/50 rounded-xl text-sm shadow-inner">
                    <p class="mb-2"><strong class="text-slate-700 dark:text-slate-300">ผู้ประสบภัย:</strong> <span id="modal-name" class="text-slate-600 dark:text-slate-400"></span></p>
                    <p class="mb-2"><strong class="text-slate-700 dark:text-slate-300">จำนวนผู้ประสบภัย:</strong> <span id="modal-company" class="text-slate-600 dark:text-slate-400"></span></p>
                    <p class="mb-2"><strong class="text-slate-700 dark:text-slate-300">ความต้องการ:</strong> <span id="modal-desc" class="text-slate-600 dark:text-slate-400"></span></p>
                    <p><strong class="text-slate-700 dark:text-slate-300">ประเภทการแจ้ง:</strong> <span id="modal-category" class="inline-block mt-1 px-2.5 py-1 bg-white dark:bg-slate-800 border border-blue-200 dark:border-blue-700 text-blue-700 dark:text-blue-400 rounded-md text-xs font-semibold"></span></p>
                </div>

                <form id="adminActionForm" onsubmit="submitAdminAction(event)">
                    <input type="hidden" id="admin_case_id">
                    
                    <label class="block text-sm font-bold text-slate-800 dark:text-white mb-3">การประเมินเบื้องต้น <span class="text-rose-500">*</span></label>
                    <div class="flex gap-4 mb-5">
                        <label class="flex-1 flex items-center justify-center gap-2 cursor-pointer border-2 border-slate-200 dark:border-slate-700 rounded-xl p-4 hover:border-indigo-400 dark:hover:border-indigo-500 transition-all has-[:checked]:border-indigo-600 dark:has-[:checked]:border-indigo-400 has-[:checked]:bg-indigo-50 dark:has-[:checked]:bg-indigo-900/30 group">
                            <input type="radio" name="admin_status" value="รับเคส" required onchange="toggleAdminForm()" class="w-4 h-4 text-indigo-600 bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 focus:ring-indigo-600">
                            <span class="font-semibold text-slate-600 dark:text-slate-400 group-has-[:checked]:text-indigo-700 dark:group-has-[:checked]:text-indigo-300">รับเรื่อง (ประสานงานต่อ)</span>
                        </label>
                        <label class="flex-1 flex items-center justify-center gap-2 cursor-pointer border-2 border-slate-200 dark:border-slate-700 rounded-xl p-4 hover:border-rose-400 dark:hover:border-rose-500 transition-all has-[:checked]:border-rose-600 dark:has-[:checked]:border-rose-400 has-[:checked]:bg-rose-50 dark:has-[:checked]:bg-rose-900/30 group">
                            <input type="radio" name="admin_status" value="ไม่รับเคส" required onchange="toggleAdminForm()" class="w-4 h-4 text-rose-600 bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 focus:ring-rose-600">
                            <span class="font-semibold text-slate-600 dark:text-slate-400 group-has-[:checked]:text-rose-700 dark:group-has-[:checked]:text-rose-300">ปฏิเสธ / แจ้งซ้ำซ้อน</span>
                        </label>
                    </div>

                    <div id="admin-reject-sec" class="hidden mb-4 p-5 bg-rose-50/50 dark:bg-rose-900/10 border border-rose-200 dark:border-rose-800/50 rounded-xl animate-fade-in-up">
                        <label class="block text-sm font-semibold text-rose-900 dark:text-rose-300 mb-2">ระบุเหตุผล <span class="text-rose-500">*</span></label>
                        <select id="admin_reject_reason" class="input-style cursor-pointer border-rose-200 dark:border-rose-800 focus:ring-rose-500 focus:border-rose-500">
                            <option value="">-- เลือกเหตุผล --</option>
                            <option value="เหตุการณ์ซ้ำซ้อน / แจ้งไปแล้ว">เหตุการณ์ซ้ำซ้อน / แจ้งไปแล้ว</option>
                            <option value="อยู่นอกพื้นที่ให้บริการ">อยู่นอกพื้นที่ให้บริการ</option>
                            <option value="ข้อมูลไม่เพียงพอต่อการเข้าช่วยเหลือ">ข้อมูลไม่เพียงพอต่อการเข้าช่วยเหลือ</option>
                        </select>
                    </div>

                    <div id="admin-forward-sec" class="hidden mb-4 p-5 bg-emerald-50/50 dark:bg-emerald-900/10 border border-emerald-200 dark:border-emerald-800/50 rounded-xl animate-fade-in-up">
                        <h4 class="font-bold text-emerald-800 dark:text-emerald-400 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                            ระบุหน่วยงานเข้าช่วยเหลือพื้นที่
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">หน่วยงานรับผิดชอบ <span class="text-rose-500">*</span></label>
                                <select id="admin_agency" class="input-style cursor-pointer border-slate-300 focus:ring-emerald-500 focus:border-emerald-500">
                                    <option value="">-- เลือกหน่วยงาน --</option>
                                    <option value="กรมป้องกันและบรรเทาสาธารณภัย (ปภ.)">กรมป้องกันและบรรเทาสาธารณภัย (ปภ.)</option>
                                    <option value="มูลนิธิร่วมกตัญญู / ป่อเต็กตึ๊ง">มูลนิธิร่วมกตัญญู / ป่อเต็กตึ๊ง</option>
                                    <option value="องค์กรปกครองส่วนท้องถิ่น (อบต./เทศบาล)">องค์กรปกครองส่วนท้องถิ่น (อบต./เทศบาล)</option>
                                    <option value="ทหาร / ตำรวจในพื้นที่">ทหาร / ตำรวจในพื้นที่</option>
                                    <option value="กระทรวงสาธารณสุข (สธ.)">กระทรวงสาธารณสุข (สธ.)</option>
                                    <option value="อาสาสมัครภาคประชาชน">อาสาสมัครภาคประชาชน</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ชื่อผู้ประสานงาน (ถ้ามี)</label>
                                    <input type="text" id="admin_agency_contact" maxlength="2000" class="input-style focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">เบอร์ติดต่อหน่วยงาน</label>
                                    <input type="tel" id="admin_agency_phone" pattern="[0-9]{9,10}" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="input-style focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-5 border-t border-slate-100 dark:border-slate-800 mt-6">
                        <button type="button" onclick="closeAdminModal()" class="px-5 py-2.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-xl font-semibold transition-colors">ยกเลิก</button>
                        <button type="submit" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-md shadow-indigo-500/30 transition-all transform hover:-translate-y-0.5">บันทึกข้อมูล</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Admin Close Case (ยุติเรื่อง) -->
    <div id="close-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[65] flex items-center justify-center p-4 hidden transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col transform transition-transform scale-95 border border-slate-200 dark:border-slate-700" id="close-modal-content">
            <div class="px-6 py-4 border-b border-emerald-100 dark:border-emerald-800/50 flex justify-between items-center bg-emerald-50 dark:bg-emerald-900/20">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-800 text-emerald-600 dark:text-emerald-300 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 class="font-bold text-lg text-emerald-800 dark:text-emerald-400">ยุติการช่วยเหลือเคส: <span id="close-modal-case-id" class="text-emerald-600"></span></h3>
                </div>
                <button onclick="closeCloseModal()" class="text-slate-400 hover:text-slate-700 dark:hover:text-white hover:bg-emerald-100 dark:hover:bg-emerald-800 p-1.5 rounded-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-6 bg-white dark:bg-slate-900">
                <form id="closeActionForm" onsubmit="submitCloseCase(event)">
                    <input type="hidden" id="close_case_id">
                    <label class="block text-sm font-semibold text-slate-800 dark:text-slate-200 mb-2">สรุปผลการเข้าช่วยเหลือ <span class="text-rose-500">*</span></label>
                    <textarea id="close_detail" required rows="4" class="input-style mb-6 resize-none focus:ring-emerald-500 focus:border-emerald-500" placeholder="ระบุผลการดำเนินงาน เช่น นำส่งผู้ป่วยเรียบร้อยแล้ว, น้ำลดเข้าสู่สภาวะปกติ..."></textarea>
                    
                    <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-800">
                        <button type="button" onclick="closeCloseModal()" class="px-5 py-2.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-xl font-semibold transition-colors">ยกเลิก</button>
                        <button type="submit" class="px-6 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-md shadow-emerald-500/30 transition-all transform hover:-translate-y-0.5">ยืนยันการยุติเรื่อง</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal View Details -->
    <div id="details-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4 hidden transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col transform transition-transform scale-95 border border-slate-200 dark:border-slate-700" id="details-modal-content">
            <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/80">
                <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    รายละเอียดเหตุการณ์: <span id="dt_id" class="text-blue-600 dark:text-blue-400"></span>
                </h3>
                <button onclick="closeDetailsModal()" class="text-slate-400 hover:text-slate-700 dark:hover:text-white hover:bg-slate-200 dark:hover:bg-slate-700 p-1.5 rounded-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-6 bg-white dark:bg-slate-900">
                
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-5 shadow-sm">
                    <div class="grid grid-cols-2 gap-y-4 gap-x-6 text-sm">
                        <div>
                            <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide mb-1">สถานะปัจจุบัน</p>
                            <div id="dt_status" class="font-medium"></div>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide mb-1">วันที่แจ้งเรื่อง</p>
                            <div id="dt_date" class="font-medium text-slate-800 dark:text-slate-200"></div>
                        </div>
                        <div class="col-span-2 border-t border-slate-100 dark:border-slate-700 pt-4 mt-2"></div>
                        <div>
                            <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide mb-1">ผู้แจ้ง / ผู้ประสบภัย</p>
                            <div id="dt_name" class="font-bold text-slate-800 dark:text-white text-base"></div>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide mb-1">จำนวนผู้ต้องการความช่วยเหลือ</p>
                            <div id="dt_company" class="font-medium text-slate-700 dark:text-slate-300"></div>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide mb-1">เบอร์ติดต่อ</p>
                            <div id="dt_phone" class="font-medium text-slate-700 dark:text-slate-300"></div>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide mb-1">พิกัด / ที่อยู่</p>
                            <div id="dt_location" class="font-medium text-slate-700 dark:text-slate-300"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-2">ข้อมูลเหตุการณ์</p>
                    <div class="space-y-3">
                        <div id="dt_category" class="font-semibold text-blue-700 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/30 border border-blue-100 dark:border-blue-800/50 px-3 py-2 rounded-lg inline-block text-sm"></div>
                        <div id="dt_problem" class="font-medium text-slate-700 dark:text-slate-300 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-4 rounded-xl leading-relaxed whitespace-pre-wrap shadow-inner text-sm"></div>
                    </div>
                </div>

                <!-- Admin Process Result -->
                <div id="dt_result_section" class="hidden">
                    <p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-2">ผลการดำเนินการจากศูนย์ฯ</p>
                    <div class="p-5 rounded-xl text-sm shadow-sm" id="dt_result_box">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
            <div class="p-5 border-t border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/80 flex justify-between items-center">
                <button id="btn-delete-case" class="hidden flex items-center gap-2 px-4 py-2.5 bg-white dark:bg-slate-800 hover:bg-rose-50 dark:hover:bg-rose-900/30 text-rose-600 dark:text-rose-400 border border-rose-200 dark:border-rose-800/50 rounded-xl font-bold transition-colors shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    ลบข้อมูล
                </button>
                <button onclick="closeDetailsModal()" class="px-8 py-2.5 bg-slate-800 dark:bg-white hover:bg-slate-900 dark:hover:bg-slate-100 text-white dark:text-slate-900 rounded-xl font-bold shadow-md transition-all ml-auto">ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <!-- Modal Admin Add User -->
    <div id="add-user-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[75] flex items-center justify-center p-4 hidden transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col transform transition-transform scale-95 border border-slate-200 dark:border-slate-700" id="add-user-modal-content">
            <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/80">
                <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                    เพิ่มผู้ใช้งานใหม่
                </h3>
                <button onclick="closeAddUserModal()" class="text-slate-400 hover:text-slate-700 dark:hover:text-white hover:bg-slate-200 dark:hover:bg-slate-700 p-1.5 rounded-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar bg-white dark:bg-slate-900 max-h-[70vh]">
                <form id="adminAddUserForm" onsubmit="submitAddUser(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">ชื่อ-นามสกุล</label>
                        <input type="text" id="add_name" required pattern="[a-zA-Zก-ฮะ-์\s]+" minlength="2" title="กรุณากรอกเฉพาะตัวอักษรภาษาไทยหรือภาษาอังกฤษเท่านั้น" oninput="this.value = this.value.replace(/[^a-zA-Zก-ฮะ-์\s]/g, '')" class="input-style">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">ชื่อผู้ใช้งาน (Username)</label>
                        <input type="text" id="add_username" required pattern="[a-zA-Z0-9]+" minlength="4" maxlength="20" class="input-style">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">รหัสผ่าน</label>
                        <div class="relative">
                            <input type="password" id="add_password" required minlength="6" class="input-style pr-12">
                            <button type="button" onclick="togglePassword('add_password', this)" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">เบอร์ติดต่อ</label>
                        <input type="tel" id="add_phone" required pattern="[0-9]{9,10}" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="input-style">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">ประเภทบัญชี (Role)</label>
                        <select id="add_role" class="input-style cursor-pointer appearance-none">
                            <option value="user">ผู้แจ้งเหตุ (User)</option>
                            <option value="admin">เจ้าหน้าที่ศูนย์ฯ (Admin)</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3 pt-5 border-t border-slate-100 dark:border-slate-800 mt-2">
                        <button type="button" onclick="closeAddUserModal()" class="px-5 py-2.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-xl font-semibold transition-colors">ยกเลิก</button>
                        <button type="submit" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-md shadow-indigo-500/30 transition-all transform hover:-translate-y-0.5">เพิ่มผู้ใช้งาน</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // ==========================================
        // ตั้งค่า Google Apps Script Web App URL ที่นี่
        // ==========================================
        const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz-EbeBe5-YaNvvlSlbV1ap1eqJF-sAA9bmLVx0E8wWey0yAzXHymywS0ycUBIVJEKiiA/exec"; 
        
        let currentUser = null; 
        let globalData = [];
        let charts = {};
        let authAnimationId;

        // --- Interactive Particle Snow Effect ---
        function initAuthParticles() {
            const canvas = document.getElementById('authCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let particles = [];
            const particleCount = Math.min(window.innerWidth / 15, 80); 

            let mouse = { x: null, y: null };
            window.addEventListener('mousemove', function(event) {
                mouse.x = event.x;
                mouse.y = event.y;
            });

            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 2.5 + 0.5;
                    this.speedX = Math.random() * 1 - 0.5;
                    this.speedY = Math.random() * 1.5 + 0.5; 
                    this.baseOpacity = Math.random() * 0.6 + 0.1;
                }

                update() {
                    this.y += this.speedY;
                    this.x += this.speedX;

                    if (mouse.x != null && mouse.y != null) {
                        let dx = mouse.x - this.x;
                        let dy = mouse.y - this.y;
                        let distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < 120) {
                            this.x -= dx / 30;
                            this.y -= dy / 30;
                        }
                    }

                    if (this.y > canvas.height) {
                        this.y = 0 - this.size;
                        this.x = Math.random() * canvas.width;
                    }
                    if (this.x > canvas.width + this.size) this.x = 0 - this.size;
                    if (this.x < 0 - this.size) this.x = canvas.width + this.size;
                }

                draw() {
                    const isDark = document.documentElement.classList.contains('dark');
                    const color = isDark ? `rgba(199, 210, 254, ${this.baseOpacity})` : `rgba(59, 130, 246, ${this.baseOpacity})`;
                    const glow = isDark ? '#a5b4fc' : '#60a5fa';

                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = glow;
                    ctx.fill();
                }
            }

            function init() {
                particles = [];
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle());
                }
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let i = 0; i < particles.length; i++) {
                    particles[i].update();
                    particles[i].draw();
                }
                authAnimationId = requestAnimationFrame(animate);
            }

            init();
            animate();

            window.addEventListener('resize', function() {
                if(document.getElementById('auth-view').classList.contains('hidden')) return;
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                init();
            });
        }

        function stopAuthParticles() {
            if (authAnimationId) {
                cancelAnimationFrame(authAnimationId);
            }
        }

        // --- Dark Mode Logic & Center Overlay Animation ---
        function applyTheme() {
            const isDark = localStorage.getItem('theme') === 'dark' || 
                (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-toggle').checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-toggle').checked = false;
            }
            updateChartColors();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateChartColors();
            showThemeIcon(isDark);
        }

        function showThemeIcon(isDark) {
            const overlay = document.getElementById('theme-icon-overlay');
            overlay.innerHTML = isDark 
                ? `<svg class="w-32 h-32 text-indigo-300 drop-shadow-[0_0_20px_rgba(165,180,252,0.6)] animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>`
                : `<svg class="w-32 h-32 text-amber-400 drop-shadow-[0_0_20px_rgba(251,191,36,0.6)] animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
            
            overlay.style.opacity = '1';
            overlay.style.transform = 'scale(1)';
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                overlay.style.transform = 'scale(1.3)';
            }, 1000);
        }

        function updateChartColors() {
            const isDark = document.documentElement.classList.contains('dark');
            Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';
            Chart.defaults.scale.grid.color = isDark ? '#334155' : '#f1f5f9';
            if(charts.cat) charts.cat.update();
            if(charts.sla) charts.sla.update();
        }

        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                btn.innerHTML = `<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>`;
            } else {
                input.type = "password";
                btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`;
            }
        }

        window.onload = () => {
            applyTheme();

            // Setup Mini Rain
            const miniRainContainer = document.getElementById('mini-rain');
            if (miniRainContainer) {
                for(let i=0; i<15; i++) {
                    let drop = document.createElement('div');
                    drop.className = 'raindrop';
                    drop.style.left = `${Math.random() * 100}%`;
                    drop.style.animationDelay = `${Math.random() * 2}s`;
                    drop.style.animationDuration = `${0.5 + Math.random() * 0.5}s`;
                    miniRainContainer.appendChild(drop);
                }
            }

            const updateTime = () => {
                const now = new Date();
                const dateOpts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const timeOpts = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                document.getElementById('currentDate').textContent = `${now.toLocaleDateString('th-TH', dateOpts)} | เวลา ${now.toLocaleTimeString('th-TH', timeOpts)} น.`;
            };
            updateTime();
            setInterval(updateTime, 1000);
            
            let savedUser = localStorage.getItem('sme_user');
            if(savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if(currentUser && currentUser.role) currentUser.role = String(currentUser.role).toLowerCase().trim();
                    initApp();
                } catch (e) {
                    console.error("Error parsing user data", e);
                    localStorage.removeItem('sme_user');
                    document.getElementById('auth-view').classList.remove('hidden');
                    document.getElementById('loader').classList.add('hidden');
                    initAuthParticles();
                }
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('loader').classList.add('hidden');
                initAuthParticles();
            }
        };

        function toggleAuth(type) {
            const formLogin = document.getElementById('form-login');
            const formReg = document.getElementById('form-register');
            const tabLogin = document.getElementById('tab-login');
            const tabReg = document.getElementById('tab-register');

            if(type === 'login') {
                formLogin.classList.remove('hidden'); formReg.classList.add('hidden');
                tabLogin.classList.add('border-blue-600', 'dark:border-blue-400', 'text-blue-600', 'dark:text-blue-400'); 
                tabLogin.classList.remove('text-slate-400', 'border-transparent');
                tabReg.classList.remove('border-blue-600', 'dark:border-blue-400', 'text-blue-600', 'dark:text-blue-400'); 
                tabReg.classList.add('text-slate-400', 'border-transparent');
            } else {
                formReg.classList.remove('hidden'); formLogin.classList.add('hidden');
                tabReg.classList.add('border-blue-600', 'dark:border-blue-400', 'text-blue-600', 'dark:text-blue-400'); 
                tabReg.classList.remove('text-slate-400', 'border-transparent');
                tabLogin.classList.remove('border-blue-600', 'dark:border-blue-400', 'text-blue-600', 'dark:text-blue-400'); 
                tabLogin.classList.add('text-slate-400', 'border-transparent');
            }
        }

        function showLoader(text) {
            document.getElementById('loader-text').textContent = text;
            const l = document.getElementById('loader');
            l.classList.remove('hidden');
            setTimeout(() => { l.style.opacity = '1'; l.style.pointerEvents = 'auto'; }, 10);
        }
        function hideLoader() {
            const l = document.getElementById('loader');
            l.style.opacity = '0';
            setTimeout(() => { l.style.pointerEvents = 'none'; l.classList.add('hidden'); }, 300);
        }

        function animateValue(id, end, duration = 1500) {
            const obj = document.getElementById(id);
            if (!obj) return;
            const start = parseInt(obj.textContent) || 0;
            if (start === end) return;
            
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 4);
                obj.innerHTML = Math.floor(easeOut * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
                else obj.innerHTML = end; 
            };
            window.requestAnimationFrame(step);
        }

        async function postToGAS(payload) {
            if(!GAS_WEBAPP_URL) {
                let mockUser = currentUser;
                if (payload.action === 'register') mockUser = { username: payload.username, role: payload.role, name: payload.name, phone: payload.phone };
                else if (payload.action === 'login') {
                    let role = payload.username.toLowerCase() === 'admin' ? 'admin' : 'user';
                    mockUser = { username: payload.username, role: role, name: "คุณ " + payload.username, phone: "0812345678" };
                }
                else if (payload.action === 'update_profile') {
                    mockUser = { ...currentUser, name: payload.new_name, phone: payload.new_phone };
                }
                else if (payload.action === 'delete_user') {
                    return new Promise(resolve => setTimeout(() => resolve({status: "success"}), 800));
                }
                return new Promise(resolve => setTimeout(() => resolve({
                    status: "success", user: mockUser, caseId: "C-1234-567",
                    data: [], users: [] 
                }), 800));
            }

            try {
                const response = await fetch(GAS_WEBAPP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                if(!response.ok) throw new Error("Network error");
                return await response.json();
            } catch(e) {
                return { status: "error", message: "ไม่สามารถเชื่อมต่อฐานข้อมูลได้" };
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const password = document.getElementById('reg_password').value;
            const confirmPassword = document.getElementById('reg_confirm_password').value;

            if (password !== confirmPassword) {
                alert("รหัสผ่านและการยืนยันรหัสผ่านไม่ตรงกัน กรุณาตรวจสอบอีกครั้ง");
                return;
            }

            showLoader("กำลังสร้างบัญชี...");
            const payload = {
                action: "register", name: document.getElementById('reg_name').value,
                username: document.getElementById('reg_username').value, password: password,
                phone: document.getElementById('reg_phone').value, role: document.getElementById('reg_role').value
            };
            const res = await postToGAS(payload);
            hideLoader();
            if(res.status === "success") {
                alert("สมัครสมาชิกสำเร็จ! กรุณาเข้าสู่ระบบ");
                toggleAuth('login'); document.getElementById('form-register').reset();
            } else alert("ข้อผิดพลาด: " + res.message);
        }

        async function handleLogin(e) {
            e.preventDefault();
            showLoader("กำลังเข้าสู่ระบบ...");
            const payload = { action: "login", username: document.getElementById('login_username').value, password: document.getElementById('login_password').value };
            const res = await postToGAS(payload);
            hideLoader();
            
            if(res.status === "success") {
                currentUser = res.user;
                if(currentUser && currentUser.role) currentUser.role = String(currentUser.role).toLowerCase().trim();
                localStorage.setItem('sme_user', JSON.stringify(currentUser));
                initApp();
            } else alert("ข้อผิดพลาด: " + res.message);
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            const newName = document.getElementById('set_name').value;
            const newPhone = document.getElementById('set_phone').value;
            const newPassword = document.getElementById('set_password').value;
            const confirmNewPassword = document.getElementById('set_confirm_password').value;

            if (newPassword || confirmNewPassword) {
                if (newPassword !== confirmNewPassword) {
                    alert("รหัสผ่านใหม่และการยืนยันรหัสผ่านไม่ตรงกัน กรุณาตรวจสอบอีกครั้ง");
                    return;
                }
                if (newPassword.length < 6) {
                    alert("รหัสผ่านใหม่ต้องมีความยาวอย่างน้อย 6 ตัวอักษร");
                    return;
                }
            }

            showLoader("กำลังบันทึกข้อมูล...");
            const payload = {
                action: "update_profile",
                username: currentUser.username, 
                new_name: newName,
                new_phone: newPhone,
                new_password: newPassword 
            };

            const res = await postToGAS(payload);
            hideLoader();
            
            if(res.status === "success") {
                alert("อัปเดตข้อมูลบัญชีสำเร็จ!");
                currentUser.name = newName;
                currentUser.phone = newPhone;
                localStorage.setItem('sme_user', JSON.stringify(currentUser));
                document.getElementById('set_password').value = "";
                document.getElementById('set_confirm_password').value = "";
                
                if (currentUser.role === 'user') {
                    document.getElementById('entrepreneur_name').value = currentUser.name || currentUser.username;
                    document.getElementById('contact_number').value = currentUser.phone || "ไม่ระบุเบอร์โทรศัพท์";
                }
                
                initApp();
            } else {
                alert("เกิดข้อผิดพลาด: " + res.message);
            }
        }

        function logout() {
            localStorage.removeItem('sme_user');
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('auth-view').classList.remove('hidden');
            document.getElementById('form-login').reset();
            initAuthParticles(); 
        }

        function initApp() {
            stopAuthParticles(); 

            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            document.getElementById('display_name').textContent = currentUser.name || currentUser.username;
            document.getElementById('display_role').textContent = currentUser.role === 'admin' ? "เจ้าหน้าที่ศูนย์ฯ" : "ผู้ประสบภัย";
            document.getElementById('avatar').textContent = (currentUser.name || currentUser.username).charAt(0).toUpperCase();
            document.getElementById('avatar').className = `w-9 h-9 shrink-0 rounded-full text-white flex items-center justify-center font-bold text-sm shadow-md ${currentUser.role === 'admin' ? 'bg-gradient-to-br from-indigo-500 to-purple-600' : 'bg-gradient-to-br from-emerald-500 to-teal-600'}`;

            document.getElementById('set_name').value = currentUser.name || currentUser.username;
            document.getElementById('set_phone').value = currentUser.phone || ""; 

            const nameInput = document.getElementById('entrepreneur_name');
            const phoneInput = document.getElementById('contact_number');

            if(currentUser.role === 'admin') {
                document.getElementById('menu-admin').classList.remove('hidden');
                document.getElementById('menu-user').classList.add('hidden');
                switchView('dashboard');
                
                nameInput.removeAttribute('readonly');
                nameInput.classList.remove('bg-slate-200', 'dark:bg-slate-800/80', 'cursor-not-allowed', 'opacity-80');
                nameInput.value = ""; 
                nameInput.title = "ชื่อผู้ประสบภัย";
                
                phoneInput.removeAttribute('readonly');
                phoneInput.classList.remove('bg-slate-200', 'dark:bg-slate-800/80', 'cursor-not-allowed', 'opacity-80');
                phoneInput.value = ""; 
                phoneInput.title = "เบอร์ติดต่อผู้ประสบภัย";
                
            } else {
                document.getElementById('menu-admin').classList.add('hidden');
                document.getElementById('menu-user').classList.remove('hidden');
                switchView('news'); 
                
                nameInput.setAttribute('readonly', 'true');
                nameInput.classList.add('bg-slate-200', 'dark:bg-slate-800/80', 'cursor-not-allowed', 'opacity-80');
                nameInput.value = currentUser.name || currentUser.username;
                nameInput.title = "ดึงข้อมูลอัตโนมัติ ไม่สามารถแก้ไขได้";
                
                phoneInput.setAttribute('readonly', 'true');
                phoneInput.classList.add('bg-slate-200', 'dark:bg-slate-800/80', 'cursor-not-allowed', 'opacity-80');
                phoneInput.value = currentUser.phone || "ไม่ระบุเบอร์โทรศัพท์";
                phoneInput.title = "ดึงข้อมูลอัตโนมัติ ไม่สามารถแก้ไขได้";
            }
            fetchData(); 
        }

        function switchView(viewId) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.view === viewId) {
                    btn.classList.add('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-400');
                    btn.classList.remove('text-slate-500', 'dark:text-slate-400', 'hover:bg-slate-100/80', 'dark:hover:bg-slate-800');
                } else {
                    btn.classList.remove('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-700', 'dark:text-blue-400');
                    btn.classList.add('text-slate-500', 'dark:text-slate-400', 'hover:bg-slate-100/80', 'dark:hover:bg-slate-800');
                }
            });

            const headers = { 
                'dashboard': 'ภาพรวมระบบ (Dashboard)', 
                'form': 'สร้างฟอร์มแจ้งเหตุ', 
                'list': currentUser.role === 'admin' ? 'จัดการรายการแจ้งเหตุ' : 'ติดตามสถานะการช่วยเหลือ',
                'manage-map': 'จัดการจุดแจกของ',
                'reports': 'รายงานสถิติ (Reports)',
                'users': 'จัดการผู้ใช้งาน (Users)',
                'settings': 'ตั้งค่าบัญชี (Settings)',
                'news': 'ข่าวสาร & จุดรับของ',
                'history': 'ประวัติการแจ้งเหตุ (History)',
                'faq': 'ศูนย์ช่วยเหลือ (FAQ)'
            };
            const subtitles = { 
                'dashboard': 'สรุปข้อมูลสถานการณ์เหตุฉุกเฉินทั้งหมด', 
                'form': 'บันทึกข้อมูลและรายละเอียดที่ต้องการความช่วยเหลือ', 
                'list': 'ตรวจสอบสถานะและอัปเดตข้อมูลผู้ประสบภัย',
                'manage-map': 'จำลองการเพิ่มพิกัดจุดแจกของหรือศูนย์ช่วยเหลือ',
                'reports': 'ดูรายงานและส่งออกข้อมูลพื้นที่เสี่ยงเป็นไฟล์ CSV',
                'users': 'จัดการสิทธิ์และบัญชีผู้ใช้งานในระบบ',
                'settings': 'แก้ไขข้อมูลส่วนตัวและเปลี่ยนรหัสผ่าน',
                'news': 'แจ้งเตือนสภาพอากาศและแผนที่จุดช่วยเหลือ',
                'history': 'ดูประวัติการร้องทุกข์ที่ได้รับการแก้ไขแล้ว',
                'faq': 'คำถามที่พบบ่อยและข้อมูลที่เป็นประโยชน์'
            };
            
            document.getElementById('header-title').textContent = headers[viewId] || 'FloodCare+';
            document.getElementById('header-subtitle').textContent = subtitles[viewId] || '';

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            
            const targetView = document.getElementById(`view-${viewId}`);
            if (targetView) {
                targetView.classList.remove('hidden', 'animate-fade-in-up');
                void targetView.offsetWidth; 
                targetView.classList.add('animate-fade-in-up');
            }
        }

        async function fetchData() {
            showLoader("กำลังอัปเดตข้อมูล...");
            try {
                let result;
                if(!GAS_WEBAPP_URL) {
                    result = {
                        status: "success",
                        data: [
                            { ID: "C-2602-002", Created_At: new Date().toISOString(), Submitter: currentUser.username, Name: "นาย สมชาย ใจดี", Company_Name: "3 คน (มีผู้สูงอายุ 1)", Phone: "0811111111", Contact: "0811111111", Location: "กทม", Category: "อพยพฉุกเฉิน / กู้ชีพ", Problem: "น้ำท่วมเข้าบ้านสูง 1 เมตร มีผู้สูงอายุ", Status: "New" },
                            { ID: "C-2602-001", Created_At: new Date(Date.now() - 86400000*2).toISOString(), Submitter: "user123", Name: "นาง สมศรี รักการค้า", Company_Name: "5 คน", Phone: "0822222222", Contact: "0822222222", Location: "อยุธยา", Category: "อาหาร / น้ำดื่ม / ถุงยังชีพ", Problem: "ขาดแคลนน้ำดื่ม อาหารแห้ง", Status: "Forwarded", Agency: "ปภ. จังหวัด" }
                        ],
                        users: [
                            { username: "admin01", name: "สมหมาย ผู้ดูแลระบบ", role: "admin" },
                            { username: "user123", name: "สมศรี รักการค้า", role: "user" }
                        ]
                    };
                    await new Promise(r => setTimeout(r, 600)); 
                } else {
                    const response = await fetch(GAS_WEBAPP_URL);
                    if(!response.ok) throw new Error();
                    result = await response.json();
                }
                
                if(result.status === "success") {
                    globalData = result.data || [];
                    let displayData = globalData;
                    
                    if(currentUser.role === 'user') {
                        displayData = globalData.filter(row => String(row.Submitter).trim() === String(currentUser.username).trim());
                    }

                    renderTable(displayData, 'case-table-body', false); 
                    
                    if(currentUser.role === 'admin') {
                        updateDashboardStats(globalData);
                        if (result.users) renderUsersTable(result.users);
                    } else {
                        const historyData = displayData.filter(row => row.Status === 'Forwarded' || row.Status === 'In Progress' || row.Status === 'Closed' || row.Status === 'Rejected');
                        renderTable(historyData, 'history-table-body', true);
                    }
                    updateNotifications(displayData);
                }
            } catch(e) { console.warn("Fetch failed"); } 
            finally { hideLoader(); }
        }

        // --- Render Users Table (Admin Only) ---
        function renderUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-12 text-slate-400 font-medium">ไม่พบข้อมูลผู้ใช้งาน</td></tr>`;
                return;
            }

            users.forEach((user, index) => {
                const delayClass = index < 10 ? `delay-${index * 100}` : '';
                let roleBadge = user.role === 'admin' 
                    ? `<span class="px-2.5 py-1 bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 rounded-md text-xs font-bold border border-indigo-200 dark:border-indigo-700">Admin</span>`
                    : `<span class="px-2.5 py-1 bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300 rounded-md text-xs font-bold border border-emerald-200 dark:border-emerald-700">User</span>`;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800 transition-colors animate-fade-in-up ${delayClass}">
                        <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-200">${user.username}</td>
                        <td class="px-6 py-4 text-slate-600 dark:text-slate-400">${user.name}</td>
                        <td class="px-6 py-4">${roleBadge}</td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex gap-2 justify-center">
                                <button class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium px-3 py-1 bg-white dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600 shadow-sm transition-all" onclick="alert('จำลอง: แก้ไขบัญชี ${user.username}')">แก้ไข</button>
                                <button class="text-rose-500 hover:text-rose-700 dark:text-rose-400 dark:hover:text-rose-300 font-medium px-3 py-1 bg-white dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600 shadow-sm transition-all" onclick="deleteUserAccount('${user.username}')">ลบ</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // --- Admin Functions: Add & Delete Users ---
        function openAddUserModal() {
            document.getElementById('adminAddUserForm').reset();
            const modal = document.getElementById('add-user-modal');
            const modalContent = document.getElementById('add-user-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.style.opacity = '1'; modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
        }

        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            const modalContent = document.getElementById('add-user-modal-content');
            modal.style.opacity = '0';
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        async function submitAddUser(e) {
            e.preventDefault();
            showLoader("กำลังสร้างบัญชีผู้ใช้งาน...");
            const payload = {
                action: "register", 
                name: document.getElementById('add_name').value,
                username: document.getElementById('add_username').value,
                password: document.getElementById('add_password').value,
                phone: document.getElementById('add_phone').value,
                role: document.getElementById('add_role').value
            };
            const res = await postToGAS(payload);
            hideLoader();
            if(res.status === "success") {
                alert("เพิ่มบัญชีผู้ใช้ใหม่สำเร็จ!");
                closeAddUserModal();
                fetchData(); 
            } else {
                alert("ข้อผิดพลาด: " + res.message);
            }
        }

        async function deleteUserAccount(usernameToDelete) {
            if (currentUser && currentUser.username === usernameToDelete) {
                alert("ไม่อนุญาตให้ลบบัญชีของตนเองที่กำลังเข้าสู่ระบบอยู่ได้");
                return;
            }
            if(!confirm(`⚠️ ยืนยันการลบบัญชีผู้ใช้ "${usernameToDelete}" ใช่หรือไม่?\nการกระทำนี้จะลบผู้ใช้ทันทีและไม่สามารถกู้คืนได้`)) return;
            
            showLoader("กำลังลบผู้ใช้งาน...");
            const res = await postToGAS({ action: "delete_user", username: usernameToDelete });
            hideLoader();
            if(res.status === "success") { 
                fetchData(); 
            } else alert("เกิดข้อผิดพลาดในการลบ: " + res.message);
        }

        function updateNotifications(filteredData) {
            if(currentUser.role === 'admin') {
                const newCases = globalData.filter(c => c.Status === 'New').length;
                const badge = document.getElementById('badge-admin-list');
                if(newCases > 0) { badge.textContent = newCases > 99 ? '99+' : newCases; badge.classList.remove('hidden'); } 
                else badge.classList.add('hidden');
            } else {
                const savedStates = JSON.parse(localStorage.getItem(`read_states_${currentUser.username}`) || '{}');
                let unread = 0;
                filteredData.forEach(c => { if(!savedStates[c.ID] || savedStates[c.ID] !== c.Status) unread++; });
                const badge = document.getElementById('badge-user-list');
                if(unread > 0) { badge.textContent = unread > 99 ? '99+' : unread; badge.classList.remove('hidden'); } 
                else badge.classList.add('hidden');
            }
        }

        function markCaseAsRead(caseId, currentStatus) {
            if(currentUser.role === 'user') {
                const savedStates = JSON.parse(localStorage.getItem(`read_states_${currentUser.username}`) || '{}');
                savedStates[caseId] = currentStatus;
                localStorage.setItem(`read_states_${currentUser.username}`, JSON.stringify(savedStates));
                updateNotifications(globalData.filter(row => row.Submitter === currentUser.username));
            }
        }

        async function submitCase(e) {
            e.preventDefault();
            showLoader("กำลังส่งคำร้อง...");
            const payload = {
                action: "submit_case", username: currentUser.username,
                entrepreneur_name: document.getElementById('entrepreneur_name').value,
                company_name: document.getElementById('company_name').value, // This is now Number of People
                contact_number: document.getElementById('contact_number').value,
                location: document.getElementById('location').value,
                problem_desc: document.getElementById('problem_desc').value,
                category: document.getElementById('category').value
            };
            const res = await postToGAS(payload);
            hideLoader();
            if(res.status === "success") {
                alert(`ส่งฟอร์มแจ้งเหตุสำเร็จ! ทางศูนย์จะรีบดำเนินการโดยเร็วที่สุด`);
                document.getElementById('caseForm').reset();
                
                setTimeout(() => {
                    if (currentUser && currentUser.role === 'user') {
                        document.getElementById('entrepreneur_name').value = currentUser.name || currentUser.username;
                        document.getElementById('contact_number').value = currentUser.phone || "ไม่ระบุเบอร์โทรศัพท์";
                    }
                }, 100);

                await fetchData();
                switchView('list');
            } else alert("เกิดข้อผิดพลาด: " + res.message);
        }

        function openDetailsModal(caseId) {
            const caseData = [...globalData].reverse().find(c => c.ID === caseId);
            if(!caseData) return;
            markCaseAsRead(caseData.ID, caseData.Status);

            let phoneVal = String(caseData.Phone || caseData.Contact || '-');
            if (phoneVal.startsWith("'")) phoneVal = phoneVal.substring(1); 
            if (phoneVal !== '-' && phoneVal.length === 9 && !phoneVal.startsWith('0')) {
                phoneVal = '0' + phoneVal; 
            }

            document.getElementById('dt_id').textContent = caseData.ID || '-';
            document.getElementById('dt_date').textContent = caseData.Created_At ? new Date(caseData.Created_At).toLocaleString('th-TH') : '-';
            document.getElementById('dt_name').textContent = caseData.Name || '-';
            document.getElementById('dt_company').textContent = caseData.Company_Name || '-'; // Shows number of people
            document.getElementById('dt_phone').textContent = phoneVal;
            document.getElementById('dt_location').textContent = caseData.Location || '-';
            document.getElementById('dt_category').textContent = caseData.Category || '-';
            document.getElementById('dt_problem').textContent = caseData.Problem || '-';

            let statusBadge = '';
            if(caseData.Status === "New") statusBadge = '<span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-lg text-xs font-bold border border-blue-200 dark:border-blue-700">รอวิเคราะห์</span>';
            else if(caseData.Status === "Forwarded") statusBadge = '<span class="px-3 py-1 bg-teal-100 dark:bg-teal-900/50 text-teal-700 dark:text-teal-300 rounded-lg text-xs font-bold border border-teal-200 dark:border-teal-700">ส่งต่อแล้ว</span>';
            else if(caseData.Status === "In Progress") statusBadge = '<span class="px-3 py-1 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-400 rounded-lg text-xs font-bold border border-amber-200 dark:border-amber-700">กำลังดำเนินการ</span>';
            else if(caseData.Status === "Closed") statusBadge = '<span class="px-3 py-1 bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-400 rounded-lg text-xs font-bold border border-emerald-200 dark:border-emerald-700">ยุติเรื่อง</span>';
            else if(caseData.Status === "Rejected") statusBadge = '<span class="px-3 py-1 bg-rose-100 dark:bg-rose-900/50 text-rose-700 dark:text-rose-400 rounded-lg text-xs font-bold border border-rose-200 dark:border-rose-700">ไม่รับเคส</span>';
            document.getElementById('dt_status').innerHTML = statusBadge;

            const resultSec = document.getElementById('dt_result_section');
            const resultBox = document.getElementById('dt_result_box');
            
            if(caseData.Status === "Rejected") {
                resultBox.className = "p-5 rounded-xl text-sm bg-rose-50 dark:bg-rose-900/20 text-rose-900 dark:text-rose-200 border border-rose-200 dark:border-rose-800";
                resultBox.innerHTML = `<strong class="text-rose-700 dark:text-rose-400">เหตุผลที่ปฏิเสธ:</strong> ${caseData.Reject_Reason || 'ไม่ระบุ'}`;
                resultSec.classList.remove('hidden');
            } else if (caseData.Status === "Forwarded" || caseData.Status === "In Progress" || caseData.Status === "Closed") {
                resultBox.className = "p-5 rounded-xl text-sm bg-emerald-50 dark:bg-emerald-900/20 text-emerald-900 dark:text-emerald-200 border border-emerald-200 dark:border-emerald-800";
                
                let closeDesc = '';
                if(caseData.Status === "Closed") {
                    closeDesc = `
                        <div class="mb-3">
                            <span class="inline-block px-2 py-1 bg-emerald-100 dark:bg-emerald-800 text-emerald-800 dark:text-emerald-100 rounded text-xs font-bold mb-2">ยุติเรื่องแล้ว</span>
                            <p><strong class="text-emerald-700 dark:text-emerald-400">รายละเอียดการยุติเรื่อง:</strong><br>${caseData.Close_Detail || '-'}</p>
                        </div>
                        <div class="border-t border-emerald-200 dark:border-emerald-800/50 pt-3"></div>`;
                }

                resultBox.innerHTML = `
                    ${closeDesc}
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <p><strong class="text-emerald-700 dark:text-emerald-400">ส่งต่อหน่วยงาน:</strong><br>${caseData.Agency || '-'}</p>
                        <p><strong class="text-emerald-700 dark:text-emerald-400">ชื่อผู้ประสานงาน:</strong><br>${caseData.Agency_Contact || '-'}</p>
                        <p class="col-span-2"><strong class="text-emerald-700 dark:text-emerald-400">เบอร์ติดต่อ:</strong> ${caseData.Agency_Phone || '-'}</p>
                    </div>`;
                resultSec.classList.remove('hidden');
            } else resultSec.classList.add('hidden');

            const deleteBtn = document.getElementById('btn-delete-case');
            if (currentUser.role === 'admin' || currentUser.username === caseData.Submitter) { 
                deleteBtn.classList.remove('hidden'); 
                deleteBtn.onclick = () => deleteCase(caseData.ID); 
            } 
            else {
                deleteBtn.classList.add('hidden');
            }

            const modal = document.getElementById('details-modal');
            const modalContent = document.getElementById('details-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.style.opacity = '1'; modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
        }

        function closeDetailsModal() {
            const modal = document.getElementById('details-modal');
            const modalContent = document.getElementById('details-modal-content');
            modal.style.opacity = '0';
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        async function deleteCase(caseId) {
            if(!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบเคส ${caseId} ?\nการกระทำนี้จะไม่สามารถกู้คืนได้`)) return;
            showLoader("กำลังลบข้อมูล...");
            const res = await postToGAS({ action: "delete_case", caseId: caseId });
            hideLoader();
            if(res.status === "success") { closeDetailsModal(); fetchData(); } 
            else alert("เกิดข้อผิดพลาดในการลบ: " + res.message);
        }

        function openAdminModal(caseId) {
            const caseData = [...globalData].reverse().find(c => c.ID === caseId);
            if(!caseData) return;

            document.getElementById('modal-case-id').textContent = caseData.ID;
            document.getElementById('modal-name').textContent = caseData.Name || '-';
            document.getElementById('modal-company').textContent = caseData.Company_Name || '-'; // Shows number of people
            document.getElementById('modal-desc').textContent = caseData.Problem || '-';
            document.getElementById('modal-category').textContent = caseData.Category ? caseData.Category.split(':')[0] : '-';
            
            document.getElementById('admin_case_id').value = caseData.ID;
            document.getElementById('adminActionForm').reset();
            toggleAdminForm();
            
            const modal = document.getElementById('admin-modal');
            const modalContent = document.getElementById('admin-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.style.opacity = '1'; modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
        }

        function closeAdminModal() {
            const modal = document.getElementById('admin-modal');
            const modalContent = document.getElementById('admin-modal-content');
            modal.style.opacity = '0';
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function toggleAdminForm() {
            const status = document.querySelector('input[name="admin_status"]:checked')?.value;
            const rejectSec = document.getElementById('admin-reject-sec');
            const forwardSec = document.getElementById('admin-forward-sec');
            
            if(status === "รับเคส") {
                rejectSec.classList.add('hidden'); forwardSec.classList.remove('hidden');
                document.getElementById('admin_reject_reason').removeAttribute('required');
                document.getElementById('admin_agency').setAttribute('required', 'true');
            } else if (status === "ไม่รับเคส") {
                rejectSec.classList.remove('hidden'); forwardSec.classList.add('hidden');
                document.getElementById('admin_reject_reason').setAttribute('required', 'true');
                document.getElementById('admin_agency').removeAttribute('required');
            } else {
                rejectSec.classList.add('hidden'); forwardSec.classList.add('hidden');
            }
        }

        async function submitAdminAction(e) {
            e.preventDefault();
            const isAccepted = document.querySelector('input[name="admin_status"]:checked').value === "รับเคส";
            const payload = {
                action: "update_case", caseId: document.getElementById('admin_case_id').value,
                analysis_status: isAccepted ? "รับเคส" : "ไม่รับเคส",
                reject_reason: isAccepted ? "" : document.getElementById('admin_reject_reason').value,
                agency: isAccepted ? document.getElementById('admin_agency').value : "",
                agency_contact: isAccepted ? document.getElementById('admin_agency_contact').value : "",
                agency_phone: isAccepted ? document.getElementById('admin_agency_phone').value : ""
            };
            showLoader("กำลังบันทึก...");
            const res = await postToGAS(payload);
            hideLoader();
            if(res.status === "success") { closeAdminModal(); fetchData(); } 
            else alert("เกิดข้อผิดพลาด: " + res.message);
        }

        function openCloseCaseModal(caseId) {
            document.getElementById('close_case_id').value = caseId;
            document.getElementById('close-modal-case-id').textContent = caseId;
            document.getElementById('closeActionForm').reset();
            
            const modal = document.getElementById('close-modal');
            const modalContent = document.getElementById('close-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.style.opacity = '1'; modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
        }

        function closeCloseModal() {
            const modal = document.getElementById('close-modal');
            const modalContent = document.getElementById('close-modal-content');
            modal.style.opacity = '0';
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        async function submitCloseCase(e) {
            e.preventDefault();
            const payload = {
                action: "close_case",
                caseId: document.getElementById('close_case_id').value,
                close_detail: document.getElementById('close_detail').value
            };
            showLoader("กำลังบันทึก...");
            const res = await postToGAS(payload);
            hideLoader();
            if(res.status === "success") { 
                closeCloseModal(); 
                fetchData(); 
            } else alert("เกิดข้อผิดพลาด: " + res.message);
        }

        function renderTable(data, targetTbodyId, isHistoryView = false) {
            const tbody = document.getElementById(targetTbodyId);
            if(!tbody) return;
            
            tbody.innerHTML = '';
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-12 text-slate-400 dark:text-slate-500 font-medium">ไม่พบข้อมูล</td></tr>`;
                return;
            }

            const sortedData = [...data].reverse();
            sortedData.forEach((row, index) => {
                let statusBadge = '';
                let unreadDot = '';
                
                if(!isHistoryView && currentUser.role === 'user') {
                    const savedStates = JSON.parse(localStorage.getItem(`read_states_${currentUser.username}`) || '{}');
                    if(!savedStates[row.ID] || savedStates[row.ID] !== row.Status) {
                        unreadDot = '<span class="inline-block w-2.5 h-2.5 rounded-full bg-rose-500 mr-2 shadow-sm shadow-rose-500/50 animate-pulse"></span>';
                    }
                }

                if(row.Status === "New") statusBadge = '<span class="px-2.5 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-md text-xs font-semibold border border-blue-100 dark:border-blue-800">รอวิเคราะห์</span>';
                else if(row.Status === "Forwarded") statusBadge = '<span class="px-2.5 py-1 bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400 rounded-md text-xs font-semibold border border-teal-100 dark:border-teal-800">ส่งต่อแล้ว</span>';
                else if(row.Status === "In Progress") statusBadge = '<span class="px-2.5 py-1 bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded-md text-xs font-semibold border border-amber-100 dark:border-amber-800">กำลังดำเนินการ</span>';
                else if(row.Status === "Closed") statusBadge = '<span class="px-2.5 py-1 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded-md text-xs font-semibold border border-emerald-100 dark:border-emerald-800">ยุติเรื่อง</span>';
                else if(row.Status === "Rejected") statusBadge = '<span class="px-2.5 py-1 bg-rose-50 dark:bg-rose-900/30 text-rose-700 dark:text-rose-400 rounded-md text-xs font-semibold border border-rose-100 dark:border-rose-800">ไม่รับเคส</span>';

                const dateStr = row.Created_At ? new Date(row.Created_At).toLocaleDateString('th-TH') : '-';
                let actionBtn = '';
                
                if(currentUser.role === 'admin' && !isHistoryView) {
                    if(row.Status === "New") {
                        actionBtn = `
                            <div class="flex gap-2 justify-center">
                                <button onclick="openDetailsModal('${row.ID}')" class="px-3 py-1.5 bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 rounded-lg text-xs font-semibold border border-slate-200 dark:border-slate-600 transition-all shadow-sm">ดูข้อมูล</button>
                                <button onclick="openAdminModal('${row.ID}')" class="px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-600 dark:hover:bg-indigo-600 hover:text-white rounded-lg text-xs font-bold border border-indigo-100 dark:border-indigo-800 hover:border-indigo-600 transition-all shadow-sm">ประเมิน</button>
                            </div>`;
                    } else if (row.Status === "Forwarded" || row.Status === "In Progress") {
                        actionBtn = `
                            <div class="flex gap-2 justify-center">
                                <button onclick="openDetailsModal('${row.ID}')" class="px-3 py-1.5 bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 rounded-lg text-xs font-semibold border border-slate-200 dark:border-slate-600 transition-all shadow-sm">รายละเอียด</button>
                                <button onclick="openCloseCaseModal('${row.ID}')" class="px-3 py-1.5 bg-emerald-50 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-600 dark:hover:bg-emerald-600 hover:text-white rounded-lg text-xs font-bold border border-emerald-100 dark:border-emerald-800 hover:border-emerald-600 transition-all shadow-sm">ยุติเรื่อง</button>
                            </div>`;
                    } else {
                        actionBtn = `<button onclick="openDetailsModal('${row.ID}')" class="px-4 py-1.5 bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 rounded-lg text-xs font-semibold border border-slate-200 dark:border-slate-600 transition-all shadow-sm">รายละเอียด</button>`;
                    }
                } else {
                    actionBtn = `<button onclick="openDetailsModal('${row.ID}')" class="px-4 py-1.5 bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 rounded-lg text-xs font-semibold border border-slate-200 dark:border-slate-600 transition-all shadow-sm">รายละเอียด</button>`;
                }

                const delayClass = index < 10 ? `delay-${index * 100}` : '';
                
                if (isHistoryView) {
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800 transition-colors animate-fade-in-up ${delayClass}">
                            <td class="px-6 py-4 font-semibold text-blue-700 dark:text-blue-400">${row.ID || '-'}</td>
                            <td class="px-6 py-4 text-slate-600 dark:text-slate-400">${dateStr}</td>
                            <td class="px-6 py-4 truncate max-w-[200px] text-slate-600 dark:text-slate-400" title="${row.Category}">${row.Category ? row.Category.split(':')[0] : '-'}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-center">${actionBtn}</td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800 transition-colors animate-fade-in-up ${delayClass}">
                            <td class="px-6 py-4 font-semibold text-blue-700 dark:text-blue-400">${unreadDot}${row.ID || '-'}</td>
                            <td class="px-6 py-4 text-slate-600 dark:text-slate-400">${dateStr}</td>
                            <td class="px-6 py-4 font-medium text-slate-800 dark:text-slate-200">${row.Name || '-'}</td>
                            <td class="px-6 py-4 truncate max-w-[150px] text-slate-600 dark:text-slate-400" title="${row.Category}">${row.Category ? row.Category.split(':')[0] : '-'}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-center">${actionBtn}</td>
                        </tr>
                    `;
                }
            });
        }

        function filterTable(targetId, inputId = "searchInput") {
            const input = document.getElementById(inputId).value.toUpperCase();
            const trs = document.getElementById(targetId).getElementsByTagName("tr");
            for (let i = 0; i < trs.length; i++) {
                if(trs[i].cells.length > 1) { 
                    const txtValue = trs[i].textContent || trs[i].innerText;
                    trs[i].style.display = txtValue.toUpperCase().indexOf(input) > -1 ? "" : "none";
                }
            }
        }

        function updateDashboardStats(data) {
            let total = data.length;
            let inProgress = 0, closed = 0, rejected = 0;
            let alerts = { yellow: 0, orange: 0, red: 0 };
            let catCount = {};

            data.forEach(row => {
                if(row.Status === "In Progress" || row.Status === "Forwarded") inProgress++;
                else if(row.Status === "Closed") closed++;
                else if(row.Status === "Rejected") rejected++;

                if(row.Category) {
                    let shortCat = row.Category.split(":")[0];
                    catCount[shortCat] = (catCount[shortCat] || 0) + 1;
                }

                if((row.Status === "Forwarded" || row.Status === "In Progress") && row.Days_Elapsed) {
                    const days = parseInt(row.Days_Elapsed);
                    if(days > 5) alerts.red++;
                    else if(days > 3) alerts.orange++;
                    else if(days > 1) alerts.yellow++;
                }
            });

            animateValue('stat-total', total);
            animateValue('stat-progress', inProgress);
            animateValue('stat-closed', closed);
            animateValue('stat-rejected', rejected);

            renderSlaChart(alerts);
            renderCategoryChart(catCount);
        }

        Chart.defaults.font.family = "'Prompt', sans-serif";

        function renderSlaChart(alerts) {
            const ctx = document.getElementById('slaChart').getContext('2d');
            if(charts.sla) charts.sla.destroy();
            let d = [alerts.yellow, alerts.orange, alerts.red];
            if(d.every(v => v === 0)) d = [0.01, 0, 0]; 
            
            charts.sla = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['เกิน 1 วัน', 'เกิน 3 วัน', 'เกิน 5 วัน'],
                    datasets: [{ 
                        data: d, 
                        backgroundColor: ['#fcd34d', '#fb923c', '#f87171'], 
                        hoverBackgroundColor: ['#f59e0b', '#f97316', '#ef4444'],
                        borderWidth: 0, hoverOffset: 4
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, cutout: '75%', 
                    plugins: { 
                        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, cornerRadius: 8 }
                    }
                }
            });
        }

        function renderCategoryChart(catCount) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if(charts.cat) charts.cat.destroy();

            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#3b82f6');   
            gradient.addColorStop(1, '#8b5cf6');

            charts.cat = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(catCount),
                    datasets: [{ 
                        label: 'จำนวนเคส', data: Object.values(catCount), 
                        backgroundColor: gradient, borderRadius: 6, borderSkipped: false
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, cornerRadius: 8 } },
                    scales: {
                        y: { beginAtZero: true, grid: { drawBorder: false } },
                        x: { grid: { display: false, drawBorder: false } }
                    },
                    animation: { y: { duration: 1000, easing: 'easeOutQuart' } }
                }
            });
        }

        // --- Export CSV Function ---
        function exportToCSV() {
            if (!globalData || globalData.length === 0) {
                alert("ไม่มีข้อมูลสำหรับส่งออก");
                return;
            }
            
            const headers = Object.keys(globalData[0]);
            let csvContent = "\uFEFF"; // BOM ป้องกันภาษาไทยเพี้ยน
            csvContent += headers.join(",") + "\n";
            
            globalData.forEach(row => {
                let rowArray = headers.map(key => {
                    let val = row[key] === null || row[key] === undefined ? "" : String(row[key]);
                    
                    if (key === 'Phone' || key === 'Contact' || key === 'Agency_Phone') {
                        if (val.startsWith("'")) val = val.substring(1);
                        if (val.length === 9 && !val.startsWith('0')) val = '0' + val;
                        if (val !== "") val = `="${val}"`; 
                    }

                    val = val.replace(/"/g, '""');
                    if (val.search(/("|,|\n)/g) >= 0) val = `"${val}"`;
                    return val;
                });
                csvContent += rowArray.join(",") + "\n";
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `FloodCare_Report_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
